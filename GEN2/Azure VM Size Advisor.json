{"version":11,"variables":[],"tiles":{"0":{"type":"data","title":"Azure VMs","query":"fetch dt.entity.host\n| filter isNotNull(azureVmSizeLabel)\n\n// get carbon data\n| lookup [fetch bizevents | filter event.provider == \"dynatrace.biz.carbon\"], lookupField:dt.entity.host, sourceField:id, prefix:\"carbon.\"\n| lookup [timeseries usage = avg(dt.host.cpu.usage), from:now()-3d, to:now(), rollup:max, interval: 30m, by:{dt.entity.host}],\n          lookupField:dt.entity.host, sourceField:id, prefix:\"cpu.\"\n| lookup [timeseries usage = avg(dt.host.memory.usage), from:now()-7d, to:now(), rollup:max, interval:30m, by:dt.entity.host],\n          lookupField:dt.entity.host, sourceField:id, prefix:\"memory.\"\n| lookup [fetch   dt.entity.azure_vm\n          | fieldsSummary azureVmSize\n          | expand values\n          | parse values[value], \"KVP{LD[a-zA-Z]+:key'='(LONG:valueLong | STRING:valueStr)','?}:vmsize\"\n          | fields label = replaceString(vmsize[label], \",\",\"\"),\n                   numCores = vmsize[numCores],\n                   memoryMb = vmsize[memoryMb]],\n         lookupField:label,\n         sourceField:azureVmSizeLabel,\n         prefix:\"azure_vm.size.\"\n  \n\n| fieldsAdd `cpu.usage_P95` = arrayPercentile(cpu.usage, 95),\n            `memory.usage_P100` = arrayPercentile(memory.usage, 100)\n\n| fields  `VM Name` = entity.name,\n          `VM Size` = azureVmSizeLabel,\n          `numCores` = azure_vm.size.numCores,\n          `memoryMb` = azure_vm.size.memoryMb,\n          `CPU` = `cpu.usage_P95`,\n          `MEM` = `memory.usage_P100`,\n          `C02 (kg)` = carbon.emissions,\n          `Recommendation` = if(cpu.usage_P95 < 40 and memory.usage_P100 < 60, \"⬇️ Downsize\", else: \"🟩 OK\")\n\n| sort numCores desc, memoryMb desc\n\n| fieldsRemove memoryMb, numCores\n","visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"connect","circleChartSettings":{"groupingThresholdType":"absolute"}},"singleValue":{"showLabel":true,"label":"","prefixIcon":"","autoscale":true,"alignment":"center"},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"columnWidths":{},"lineWrapIds":[["VM Name"]],"enableLineWrap":true},"unitsOverrides":[{"identifier":"dt.host.cpu.usage","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":2,"suffix":"","delimiter":true},{"identifier":"dt.host.net.nic.traffic_out","unitCategory":"datarate","baseUnit":"bitps","displayUnit":null,"decimals":2,"suffix":"","delimiter":true},{"identifier":"dt.host.memory.usage","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":2,"suffix":"","delimiter":true},{"identifier":"dt.host.net.nic.link_util_tx","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":2,"suffix":"","delimiter":true}]},"visualization":"table"},"1":{"type":"data","title":"Hosts Recommended for Downsizing","query":"fetch dt.entity.host\n| filter isNotNull(azureVmSizeLabel)\n// get carbon data\n//| lookup [fetch bizevents | filter event.provider == \"dynatrace.biz.carbon\"], lookupField:dt.entity.host, sourceField:id, prefix:\"carbon.\"\n| lookup [timeseries usage = avg(dt.host.cpu.usage), from:now()-3d, to:now(), rollup:max, interval: 30m, by:{dt.entity.host}],\n          lookupField:dt.entity.host, sourceField:id, prefix:\"cpu.\"\n| lookup [timeseries usage = avg(dt.host.memory.usage), from:now()-7d, to:now(), rollup:max, interval:30m, by:dt.entity.host],\n          lookupField:dt.entity.host, sourceField:id, prefix:\"memory.\"\n\n| fieldsAdd `cpu.usage_P95` = arrayPercentile(cpu.usage, 95),\n            `memory.usage_P100` = arrayPercentile(memory.usage, 100)\n\n| fields `Downsize` = if(cpu.usage_P95 < 40 and memory.usage_P100 < 60, true)\n\n| filter isNotNull(Downsize)\n| summarize count(), by:{Downsize}\n","visualization":"singleValue","visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"connect","circleChartSettings":{"groupingThresholdType":"absolute"}},"singleValue":{"showLabel":false,"label":"","prefixIcon":"","recordField":"count()","autoscale":false,"alignment":"center"},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"columnWidths":{}},"unitsOverrides":[{"identifier":"dt.host.cpu.usage","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":2,"suffix":"","delimiter":true},{"identifier":"dt.host.memory.usage","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":2,"suffix":"","delimiter":true}]}},"2":{"type":"data","title":"Hosts Analysed","query":"fetch dt.entity.host\n| filter isNotNull(azureVmSizeLabel)\n| summarize count()\n","visualization":"singleValue","visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"connect","circleChartSettings":{"groupingThresholdType":"absolute"}},"singleValue":{"showLabel":false,"label":"","prefixIcon":"","recordField":"count()","autoscale":false,"alignment":"center"},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"lineWrapIds":[],"columnWidths":{}},"unitsOverrides":[{"identifier":"dt.host.cpu.usage","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":2,"suffix":"","delimiter":true},{"identifier":"dt.host.memory.usage","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":2,"suffix":"","delimiter":true}]}},"3":{"type":"markdown","title":"","content":"## Azure VM Sizing Recommendations\n\nUsing statistical analysis of your VM activity over the last 7 days, these recommendations aim to help your reduce costs and CO2 emissions. \n\nThe report is ordered by largest VM first/\n\n### Calculation\n\nThe calculation is a multistage aggregation to gain intelligent insights into the utilisation of the VMs. It uses CPU and Memory usage as key metrics\n\n*Stage 1* - Average metrics over 1m\n\n*Stage 2* - Rollup the metrics into 30m buckets and take the MAX value\n\n*Stage 3* - Take the P95 for CPU Usage and P100 for Memory Usage over last 7 Days\n\n*Thresholds* - `IF P95 CPU < 40% AND P100 MEM < 60%` recommend downsize"},"4":{"type":"data","title":"Carbon Emissions of Oversized Hosts (kg)","query":"fetch dt.entity.host\n| filter isNotNull(azureVmSizeLabel)\n\n// get carbon data\n| lookup [fetch bizevents | filter event.provider == \"dynatrace.biz.carbon\"], lookupField:dt.entity.host, sourceField:id, prefix:\"carbon.\"\n| lookup [timeseries usage = avg(dt.host.cpu.usage), from:now()-3d, to:now(), rollup:max, interval: 30m, by:{dt.entity.host}],\n          lookupField:dt.entity.host, sourceField:id, prefix:\"cpu.\"\n| lookup [timeseries usage = avg(dt.host.memory.usage), from:now()-7d, to:now(), rollup:max, interval:30m, by:dt.entity.host],\n          lookupField:dt.entity.host, sourceField:id, prefix:\"memory.\"\n  \n\n| fieldsAdd `cpu.usage_P95` = arrayPercentile(cpu.usage, 95),\n            `memory.usage_P100` = arrayPercentile(memory.usage, 100)\n\n| fields  `host` = entity.name,\n          `cpu.usage_P95`,\n          `memory.usage_P100`,\n          `C02 (Kg)` = carbon.emissions,\n          `Recommendation` = if(cpu.usage_P95 < 40 and memory.usage_P100 < 60, \"⬇️ Downsize\", else: \"🟩\")\n\n| filter Recommendation == \"⬇️ Downsize\"\n\n| summarize sum(`C02 (Kg)`)","visualization":"singleValue","visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"connect","circleChartSettings":{"groupingThresholdType":"absolute"}},"singleValue":{"showLabel":false,"label":"","prefixIcon":"","autoscale":true,"alignment":"center"},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"columnWidths":{}},"unitsOverrides":[{"identifier":"dt.host.cpu.usage","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":2,"suffix":"","delimiter":true},{"identifier":"dt.host.memory.usage","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":2,"suffix":"","delimiter":true}]}},"5":{"type":"data","title":"Num Oversized VM by Type","query":"fetch dt.entity.host\n| filter isNotNull(azureVmSizeLabel)\n\n// get carbon data\n| lookup [fetch bizevents | filter event.provider == \"dynatrace.biz.carbon\"], lookupField:dt.entity.host, sourceField:id, prefix:\"carbon.\"\n| lookup [timeseries usage = avg(dt.host.cpu.usage), from:now()-3d, to:now(), rollup:max, interval: 30m, by:{dt.entity.host}],\n          lookupField:dt.entity.host, sourceField:id, prefix:\"cpu.\"\n| lookup [timeseries usage = avg(dt.host.memory.usage), from:now()-7d, to:now(), rollup:max, interval:30m, by:dt.entity.host],\n          lookupField:dt.entity.host, sourceField:id, prefix:\"memory.\"\n| lookup [fetch   dt.entity.azure_vm\n          | fieldsSummary azureVmSize\n          | expand values\n          | parse values[value], \"KVP{LD[a-zA-Z]+:key'='(LONG:valueLong | STRING:valueStr)','?}:vmsize\"\n          | fields label = replaceString(vmsize[label], \",\",\"\"),\n                   numCores = vmsize[numCores],\n                   memoryMb = vmsize[memoryMb]],\n         lookupField:label,\n         sourceField:azureVmSizeLabel,\n         prefix:\"azure_vm.size.\"\n\n| fieldsAdd `cpu.usage_P95` = arrayPercentile(cpu.usage, 95),\n            `memory.usage_P100` = arrayPercentile(memory.usage, 100)\n\n| fields  `VM Name` = entity.name,\n          `VM Size` = azureVmSizeLabel,\n          `numCores` = azure_vm.size.numCores,\n          `memoryMb` = azure_vm.size.memoryMb,\n          `CPU` = `cpu.usage_P95`,\n          `MEM` = `memory.usage_P100`,\n          `C02 (kg)` = carbon.emissions,\n          `Recommendation` = if(cpu.usage_P95 < 40 and memory.usage_P100 < 60, \"⬇️ Downsize\", else: \"🟩 OK\")\n\n| sort numCores desc, memoryMb desc\n\n| fieldsRemove memoryMb, numCores\n| filter `Recommendation` == \"⬇️ Downsize\"\n| summarize count = count(), by:{`VM Size`}","visualization":"table","visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"connect","circleChartSettings":{"groupingThresholdType":"absolute"}},"singleValue":{"showLabel":true,"label":"","prefixIcon":"","autoscale":true,"alignment":"center"},"table":{"rowDensity":"condensed","enableLineWrap":true,"enableSparklines":false,"hiddenColumns":[],"lineWrapIds":[],"columnWidths":{}},"unitsOverrides":[{"identifier":"dt.host.cpu.usage","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":2,"suffix":"","delimiter":true},{"identifier":"dt.host.memory.usage","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":2,"suffix":"","delimiter":true}]}}},"layouts":{"0":{"x":0,"y":9,"w":24,"h":11},"1":{"x":11,"y":3,"w":7,"h":3},"2":{"x":11,"y":0,"w":7,"h":3},"3":{"x":0,"y":0,"w":11,"h":9},"4":{"x":11,"y":6,"w":7,"h":3},"5":{"x":18,"y":0,"w":6,"h":9}}}